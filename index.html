<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Drone Camera Settings Field Tool</title>
  <meta name="theme-color" content="#0b0d10" />

  <style>
    :root{
      --bg:#0b0d10;
      --fg:#e9eef5;
      --muted:#9aa7b6;
      --card:rgba(255,255,255,0.07);
      --card2:rgba(255,255,255,0.05);
      --border:rgba(255,255,255,0.12);
      --accent:#7dd3fc;
      --ok:#86efac;
      --warn:#fde68a;
      --bad:#fca5a5;
      --shadow: 0 14px 40px rgba(0,0,0,.55);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Helvetica, Arial, sans-serif;
      background:
        radial-gradient(1100px 700px at 20% -10%, rgba(125,211,252,.10), transparent 55%),
        radial-gradient(900px 700px at 90% 10%, rgba(134,239,172,.08), transparent 60%),
        radial-gradient(900px 700px at 50% 120%, rgba(253,230,138,.06), transparent 60%),
        var(--bg);
      color: var(--fg);
    }

    .wrap{
      max-width: 760px;
      margin: 0 auto;
      padding: 18px 14px 28px;
    }

    header{
      display:flex;
      align-items:flex-start;
      gap:12px;
      margin: 6px 0 14px;
    }

    .badge{
      width:44px; height:44px;
      border-radius: 14px;
      background: rgba(125,211,252,.12);
      border: 1px solid rgba(125,211,252,.20);
      display:grid;
      place-items:center;
      flex: 0 0 auto;
    }
    .badge svg{ opacity:.95 }

    h1{
      font-size: 18px;
      margin:0;
      line-height: 1.2;
      letter-spacing: .2px;
    }
    .sub{
      margin:4px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    /* Progress */
    .progressRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .progressText{
      font-size: 12px;
      color: var(--muted);
    }
    .bar{
      flex: 1 1 auto;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width: 0%;
      background: rgba(125,211,252,.35);
      border-right: 1px solid rgba(125,211,252,.55);
      transition: width .18s ease;
    }

    /* Step */
    .step{
      display:none;
      padding: 12px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,.18);
      margin-bottom: 10px;
    }
    .step.active{ display:block; }

    .stepTitle{
      font-size: 14px;
      margin: 0 0 6px;
      letter-spacing: .2px;
    }
    .stepHint{
      color: var(--muted);
      font-size: 12px;
      margin: 0 0 10px;
      line-height: 1.35;
    }

    /* Big option buttons */
    .options{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .optBtn{
      appearance:none;
      -webkit-tap-highlight-color: transparent;
      width:100%;
      text-align:left;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--fg);
      padding: 12px 12px;
      cursor:pointer;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      min-height: 54px;
    }
    .optBtn:active{ transform: translateY(1px); }
    .optBtn .t{
      display:flex;
      flex-direction:column;
      gap: 3px;
    }
    .optBtn .t b{
      font-size: 14px;
      letter-spacing: .1px;
    }
    .optBtn .t span{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.25;
    }
    .optBtn .pill{
      flex: 0 0 auto;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      align-self:center;
    }

    .optBtn.selected{
      border-color: rgba(125,211,252,.35);
      background: rgba(125,211,252,.10);
    }
    .optBtn.selected .pill{
      border-color: rgba(134,239,172,.35);
      background: rgba(134,239,172,.10);
      color: var(--fg);
    }

    /* Toggles */
    .toggles{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .toggle{
      background: var(--card2);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      min-height: 52px;
    }
    .toggle .t-title{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .toggle .t-title span:first-child{
      font-size: 13px;
      color: var(--fg);
    }
    .toggle .t-title span:last-child{
      font-size: 11px;
      color: var(--muted);
    }

    .switch{
      position:relative;
      width: 44px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.07);
      flex: 0 0 auto;
    }
    .switch input{
      opacity:0;
      width:0; height:0;
      position:absolute;
    }
    .knob{
      position:absolute;
      top: 3px; left: 3px;
      width: 20px; height: 20px;
      border-radius: 999px;
      background: rgba(233,238,245,.92);
      transition: transform .18s ease;
    }
    .switch input:checked + .knob{
      transform: translateX(18px);
      background: rgba(134,239,172,.95);
    }

    /* Nav */
    .nav{
      display:flex;
      gap: 10px;
      margin-top: 12px;
    }
    button{
      width:100%;
      appearance:none;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--fg);
      padding: 12px 12px;
      font-size: 15px;
      outline: none;
      cursor:pointer;
      font-weight: 650;
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .primary{
      border: 1px solid rgba(125,211,252,.30);
      background: rgba(125,211,252,.14);
    }

    /* Result */
    .result{
      display:none;
      margin-top: 12px;
      padding: 14px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: rgba(0,0,0,.22);
    }
    .result h2{
      margin:0 0 10px;
      font-size: 15px;
      letter-spacing: .2px;
    }
    .chips{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }
    .chip{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--fg);
    }
    .chip.ok{ border-color: rgba(134,239,172,.35); background: rgba(134,239,172,.12); }
    .chip.warn{ border-color: rgba(253,230,138,.35); background: rgba(253,230,138,.10); }
    .chip.bad{ border-color: rgba(252,165,165,.35); background: rgba(252,165,165,.10); }

    .kv{
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .kv .line{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .k{
      color: var(--muted);
      font-size: 13px;
    }
    .v{
      font-size: 14px;
      font-weight: 650;
      text-align:right;
    }

    .notes{
      margin-top: 10px;
      font-size: 13px;
      line-height: 1.45;
      color: var(--muted);
    }

    .small{
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
      line-height: 1.35;
    }

    @media (min-width: 720px){
      h1{ font-size: 20px; }
      .options{ grid-template-columns: 1fr 1fr; }
      .kv{ grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="badge" aria-hidden="true">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
          <path d="M12 2l7 4v6c0 5-3.5 9-7 10-3.5-1-7-5-7-10V6l7-4z" stroke="rgba(233,238,245,.92)" stroke-width="1.6"/>
          <path d="M8.6 12.2l2.1 2.1 4.6-4.8" stroke="rgba(134,239,172,.95)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div>
        <h1>Drone Camera Settings, Field Cheat Tool</h1>
        <p class="sub">Wizard mode, big buttons, phone friendly. Answer a few questions, get recommended starting settings and an ND suggestion.</p>
      </div>
    </header>

    <div class="card">
      <div class="progressRow">
        <div class="progressText" id="progressText">Step 1 of 4</div>
        <div class="bar" aria-hidden="true"><div id="barFill"></div></div>
      </div>

      <!-- STEP 1: DRONE -->
      <section class="step active" id="step1">
        <h3 class="stepTitle">1) Which drone are you flying?</h3>
        <p class="stepHint" id="droneHint">Pick the aircraft so we can tailor the advice.</p>
        <div class="options" id="droneOptions"></div>
      </section>

      <!-- STEP 2: OUTPUT -->
      <section class="step" id="step2">
        <h3 class="stepTitle">2) What are you shooting?</h3>
        <p class="stepHint">Choose video, photo, or both.</p>
        <div class="options" id="modeOptions"></div>
      </section>

      <!-- STEP 3: LIGHTING -->
      <section class="step" id="step3">
        <h3 class="stepTitle">3) What is the lighting like?</h3>
        <p class="stepHint">This mainly influences ISO targets and ND choice.</p>
        <div class="options" id="lightingOptions"></div>
      </section>

      <!-- STEP 4: MISSION -->
      <section class="step" id="step4">
        <h3 class="stepTitle">4) What style of mission is it?</h3>
        <p class="stepHint">This is where shutter and frame rate decisions happen.</p>
        <div class="options" id="missionOptions"></div>

        <div class="toggles">
          <div class="toggle" title="PAL prefers 25/50 fps, NTSC prefers 30/60 fps.">
            <div class="t-title">
              <span>PAL mode</span>
              <span>25/50 base fps</span>
            </div>
            <label class="switch" aria-label="PAL mode">
              <input id="palToggle" type="checkbox" checked />
              <span class="knob"></span>
            </label>
          </div>

          <div class="toggle" title="Lock white balance for video to avoid colour shifts mid-clip.">
            <div class="t-title">
              <span>Lock white balance</span>
              <span>recommended for video</span>
            </div>
            <label class="switch" aria-label="Lock white balance">
              <input id="wbToggle" type="checkbox" checked />
              <span class="knob"></span>
            </label>
          </div>

          <div class="toggle" title="Use D-Log M or D-Cinelike if the drone supports it, otherwise normal.">
            <div class="t-title">
              <span>Use flat profile</span>
              <span>if available</span>
            </div>
            <label class="switch" aria-label="Use flat profile">
              <input id="flatToggle" type="checkbox" checked />
              <span class="knob"></span>
            </label>
          </div>

          <div class="toggle" title="If on, we favour keeping ISO down and suggest ND more aggressively for video.">
            <div class="t-title">
              <span>Prioritise low ISO</span>
              <span>cleaner image</span>
            </div>
            <label class="switch" aria-label="Prioritise low ISO">
              <input id="isoToggle" type="checkbox" checked />
              <span class="knob"></span>
            </label>
          </div>
        </div>
      </section>

      <div class="nav">
        <button id="backBtn" type="button" disabled>Back</button>
        <button id="nextBtn" class="primary" type="button" disabled>Next</button>
      </div>

      <div class="nav" style="margin-top:10px;">
        <button id="resetBtn" type="button">Reset</button>
        <button id="copyBtn" class="primary" type="button" disabled>Copy result</button>
      </div>

      <div id="result" class="result">
        <h2>Recommended starting settings</h2>
        <div id="chips" class="chips"></div>
        <div class="kv" id="kv"></div>
        <div class="notes" id="notes"></div>
        <div class="small" id="specs"></div>
      </div>

      <div class="small">
        This is a “get it right quickly” tool. Use it as a starting point, do a 3-second test clip, then adjust.
      </div>
    </div>
  </div>

  <script>
    // ------------------------------------------------------------
    // Drone spec notes (guidance)
    // ------------------------------------------------------------
    const DRONES = {
      mini1: {
        name: "Mavic Mini Mk1",
        sensor: "1/2.3\" CMOS, 12MP",
        aperture: "f/2.8 (fixed)",
        log: "No (normal profile)",
        maxVideo: "2.7K 25/30, 1080p up to 60",
        nd: "Aftermarket only",
        notes: "Great for daylight, keep ISO low. 2.7K is your quality ceiling.",
        photoRaw: "No RAW (JPEG only on Mk1 in DJI Fly)"
      },
      neo2: {
        name: "Neo Mk2",
        sensor: "1/2\" CMOS, 12MP",
        aperture: "f/2.2 (fixed)",
        log: "Limited (treat as normal profile unless you know otherwise)",
        maxVideo: "4K up to 60",
        nd: "Aftermarket available",
        notes: "Small drone, small sensor, it’s a daylight/social tool. Don’t chase miracles at night.",
        photoRaw: "Varies (check app options)"
      },
      mini3p: {
        name: "Mini 3 Pro",
        sensor: "1/1.3\" CMOS",
        aperture: "f/1.7 (fixed)",
        log: "D-Cinelike (yes)",
        maxVideo: "4K up to 60",
        nd: "Aftermarket / third-party",
        notes: "Very capable. f/1.7 means you’ll want ND quickly in daylight if using the 180° shutter rule.",
        photoRaw: "RAW supported (DNG)"
      },
      mini5p: {
        name: "Mini 5 Pro",
        sensor: "1\" CMOS, 50MP",
        aperture: "f/1.8 (fixed)",
        log: "D-Log M / HLG (model dependent)",
        maxVideo: "4K (high fps supported)",
        nd: "DJI Fly More ND kit available",
        notes: "Big sensor for a mini, still benefits from ND to keep motion natural.",
        photoRaw: "RAW supported"
      },
      m4dt: {
        name: "Matrice 4DT",
        sensor: "Multi-camera payload",
        aperture: "Depends on camera",
        log: "Enterprise profiles vary",
        maxVideo: "Depends on camera",
        nd: "Not a typical consumer ND workflow",
        notes: "Treat as an ops platform. For nice clips, keep it stable and conservative.",
        photoRaw: "Depends on capture mode"
      }
    };

    // ------------------------------------------------------------
    // Options for steps (big buttons)
    // ------------------------------------------------------------
    const OPTIONS = {
      drone: [
        { value:"mini1", title:"Mavic Mini Mk1", desc:"Lightweight, daylight friendly.", pill:"Mini Mk1" },
        { value:"neo2",  title:"Neo Mk2",        desc:"Compact, quick shots, limited low light.", pill:"Neo" },
        { value:"mini3p",title:"Mini 3 Pro",     desc:"Very capable, f/1.7, loves ND in daylight.", pill:"Mini 3 Pro" },
        { value:"mini5p",title:"Mini 5 Pro",     desc:"1-inch sensor class, ND kit assumed.", pill:"Mini 5 Pro" },
        { value:"m4dt",  title:"Matrice 4DT",    desc:"Enterprise platform, multi-camera.", pill:"Matrice" }
      ],
      mode: [
        { value:"video", title:"Video", desc:"Cinematic and motion settings.", pill:"Video" },
        { value:"photo", title:"Photo", desc:"Still photo and HDR guidance.", pill:"Photo" },
        { value:"both",  title:"Both",  desc:"One preset for video plus one for photo.", pill:"Both" }
      ],
      lighting: [
        { value:"bright",  title:"Bright sun / snow glare", desc:"Harsh highlights, ND likely.", pill:"Bright" },
        { value:"mixed",   title:"Sun + clouds (changeable)", desc:"Exposure shifts quickly.", pill:"Mixed" },
        { value:"overcast",title:"Overcast", desc:"Flatter light, ND lighter.", pill:"Overcast" },
        { value:"golden",  title:"Golden hour", desc:"Warm light, easier highlights.", pill:"Golden" },
        { value:"dusk",    title:"Dusk / low light", desc:"Noise creeps in, slow down.", pill:"Dusk" },
        { value:"night",   title:"Night (street lights etc.)", desc:"Expect limits, keep motion smooth.", pill:"Night" }
      ],
      mission: [
        { value:"cinematic",    title:"Cinematic (slow, smooth)", desc:"Natural motion blur, clean grading.", pill:"Smooth" },
        { value:"trackingSlow", title:"Tracking (gentle follow)", desc:"Walking pace, soft motion.", pill:"Track" },
        { value:"trackingFast", title:"Tracking (cars, fast movement)", desc:"Higher fps, keep subject exposed.", pill:"Fast" },
        { value:"actionCrisp",  title:"Action crisp (short shutter)", desc:"Staccato look, sharp action.", pill:"Crisp" },
        { value:"landscapePhoto",title:"Landscape / stills", desc:"RAW, ISO discipline, AEB for HDR.", pill:"Stills" },
        { value:"nightVideo",   title:"Night video", desc:"Stick to 180° rule, slow moves, accept blur.", pill:"Night" }
      ]
    };

    // ------------------------------------------------------------
    // State
    // ------------------------------------------------------------
    const state = {
      step: 1,
      drone: "",
      mode: "",
      lighting: "",
      mission: "",
      pal: true,
      wb: true,
      flat: true,
      iso: true
    };

    // ------------------------------------------------------------
    // DOM
    // ------------------------------------------------------------
    const stepEls = {
      1: document.getElementById("step1"),
      2: document.getElementById("step2"),
      3: document.getElementById("step3"),
      4: document.getElementById("step4")
    };

    const droneHint = document.getElementById("droneHint");

    const droneOptions = document.getElementById("droneOptions");
    const modeOptions = document.getElementById("modeOptions");
    const lightingOptions = document.getElementById("lightingOptions");
    const missionOptions = document.getElementById("missionOptions");

    const backBtn = document.getElementById("backBtn");
    const nextBtn = document.getElementById("nextBtn");
    const resetBtn = document.getElementById("resetBtn");
    const copyBtn = document.getElementById("copyBtn");

    const progressText = document.getElementById("progressText");
    const barFill = document.getElementById("barFill");

    const resultEl = document.getElementById("result");
    const chipsEl = document.getElementById("chips");
    const kvEl = document.getElementById("kv");
    const notesEl = document.getElementById("notes");
    const specsEl = document.getElementById("specs");

    const palToggle = document.getElementById("palToggle");
    const wbToggle = document.getElementById("wbToggle");
    const flatToggle = document.getElementById("flatToggle");
    const isoToggle = document.getElementById("isoToggle");

    // ------------------------------------------------------------
    // Helpers
    // ------------------------------------------------------------
    function roundShutter(target){
      const common = [30,40,50,60,80,100,120,160,200,240,250,320,400,500,640,800,1000,1600,2000,3200,4000,8000];
      let best = common[0];
      let bestDiff = Math.abs(common[0] - target);
      for (const v of common){
        const d = Math.abs(v - target);
        if (d < bestDiff){ best = v; bestDiff = d; }
      }
      return best;
    }
    function fmtShutter(den){ return `1/${den}`; }
    function baseFps(){ return state.pal ? 25 : 30; }

    function el(tag, cls){
      const x = document.createElement(tag);
      if (cls) x.className = cls;
      return x;
    }
    function chip(text, kind){
      const d = el("div", `chip ${kind || ""}`.trim());
      d.textContent = text;
      return d;
    }
    function line(k, v){
      const d = el("div", "line");
      d.innerHTML = `<div class="k">${k}</div><div class="v">${v}</div>`;
      return d;
    }

    function supportsFlatProfile(droneKey){
      const log = (DRONES[droneKey]?.log || "").toLowerCase();
      return log.includes("d-log") || log.includes("d-cinelike") || log.includes("hlg");
    }
    function pickProfile(droneKey){
      if (!state.flat) return "Normal";
      if (!supportsFlatProfile(droneKey)) return "Normal";
      const log = DRONES[droneKey].log || "";
      if (log.toLowerCase().includes("d-log m")) return "D-Log M";
      if (log.toLowerCase().includes("d-cinelike")) return "D-Cinelike";
      if (log.toLowerCase().includes("hlg")) return "HLG";
      return "Normal";
    }

    function wbSuggestion(lighting){
      if (!state.wb) return "Auto (not recommended for video)";
      switch(lighting){
        case "bright": return "Lock WB ~5600K (sunny)";
        case "mixed": return "Lock WB ~5600–6000K (pick one and stick to it)";
        case "overcast": return "Lock WB ~6500K (cloudy)";
        case "golden": return "Lock WB ~4500–5200K (golden hour)";
        case "dusk": return "Lock WB ~4200–5200K (tweak to taste)";
        case "night": return "Lock WB ~3200–4200K (street lights vary)";
        default: return "Lock white balance";
      }
    }

    function ndSuggestion(lighting, mission, droneKey){
      const hasKit = (droneKey === "mini5p");
      const wantsCrisp = (mission === "actionCrisp");
      const wantsNight = (lighting === "night" || lighting === "dusk");

      if (wantsNight) return "No ND (remove filters, keep light)";

      let nd;
      switch(lighting){
        case "bright":  nd = wantsCrisp ? "ND16–ND32" : "ND32–ND64"; break;
        case "mixed":   nd = wantsCrisp ? "ND8–ND16"  : "ND16–ND32"; break;
        case "overcast":nd = wantsCrisp ? "ND4–ND8"   : "ND8–ND16";  break;
        case "golden":  nd = wantsCrisp ? "ND4"       : "ND4–ND8";   break;
        default:        nd = "No ND";
      }
      return hasKit ? `${nd} (Fly More ND kit where possible)` : `${nd} (if you have one)`;
    }

    function isoSuggestion(lighting, droneKey){
      const biggish = (droneKey === "mini3p" || droneKey === "mini5p");
      if (lighting === "bright" || lighting === "golden") return "ISO 100 (cap 200 if Auto)";
      if (lighting === "mixed" || lighting === "overcast") return biggish ? "ISO 100–400" : "ISO 100–200 (try to stay low)";
      if (lighting === "dusk") return biggish ? "ISO 400–800 (cap 800)" : "ISO 200–800 (cap 800, accept noise)";
      if (lighting === "night") return biggish ? "ISO 800–1600 (cap 1600 if possible)" : "ISO 800+ (expect noise, keep motion slow)";
      return "ISO 100–400";
    }

    function pickFps(mission){
      const base = baseFps();
      if (mission === "landscapePhoto") return null;
      if (mission === "trackingFast" || mission === "actionCrisp") return base * 2;
      return base;
    }

    function shutterForMission(fps, mission){
      if (!fps) return null;
      const cinematicDen = roundShutter(2 * fps);
      if (mission === "actionCrisp"){
        const crispDen = roundShutter(4 * fps);
        return { den: crispDen, rule: "Crisp action (short shutter)" };
      }
      if (mission === "nightVideo"){
        return { den: cinematicDen, rule: "Night (stick near 180° for light)" };
      }
      return { den: cinematicDen, rule: "180° rule (natural motion blur)" };
    }

    function exposureNotes(lighting, mission){
      const arr = [];
      if (lighting === "bright") arr.push("Watch highlights (snow/sky), use zebras or histogram if available.");
      if (lighting === "mixed") arr.push("Set exposure for the subject, not the brightest cloud, re-check often.");
      if (lighting === "night") arr.push("Fly slower than feels natural, avoid fast yaw, it turns to mush quickly.");
      if (mission === "cinematic") arr.push("Use slow yaw and gentle stick curves, keep gimbal movement lazy.");
      if (mission === "trackingFast") arr.push("Prioritise the subject exposure, background can clip if needed.");
      if (mission === "actionCrisp") arr.push("Short shutter can look staccato, that is the point.");
      return arr;
    }

    function photoPreset(lighting, droneKey){
      const raw = DRONES[droneKey]?.photoRaw || "Depends on model";
      const base = [];
      base.push(["Format", raw.includes("RAW") ? "RAW (DNG) if available" : "Highest quality available"]);
      base.push(["ISO", "ISO 100 (raise only if you must)"]);
      base.push(["WB", lighting === "night" ? "Try 3200–4200K" : "Daylight/Cloudy to match scene"]);
      base.push(["Mode", "Single + AEB (3–5 frames) for HDR scenes"]);
      base.push(["Focus", "Tap to focus, then lock if possible"]);
      base.push(["Tip", "If it’s windy, take multiple shots and pick the sharpest."]);
      return base;
    }

    // ------------------------------------------------------------
    // Wizard rendering
    // ------------------------------------------------------------
    function renderOptions(container, list, selectedValue, onPick){
      container.innerHTML = "";
      for (const opt of list){
        const b = el("button", "optBtn");
        b.type = "button";
        b.dataset.value = opt.value;
        b.innerHTML = `
          <div class="t">
            <b>${opt.title}</b>
            <span>${opt.desc}</span>
          </div>
          <div class="pill">${opt.pill || "Pick"}</div>
        `;
        if (opt.value === selectedValue) b.classList.add("selected");
        b.addEventListener("click", () => onPick(opt.value));
        container.appendChild(b);
      }
    }

    function markSelected(container, value){
      [...container.querySelectorAll(".optBtn")].forEach(btn => {
        btn.classList.toggle("selected", btn.dataset.value === value);
      });
    }

    function canAdvance(step){
      if (step === 1) return !!state.drone;
      if (step === 2) return !!state.mode;
      if (step === 3) return !!state.lighting;
      if (step === 4) return !!state.mission;
      return false;
    }

    function updateProgress(){
      const total = 4;
      progressText.textContent = `Step ${state.step} of ${total}`;
      barFill.style.width = `${Math.round((state.step / total) * 100)}%`;

      for (let i = 1; i <= total; i++){
        stepEls[i].classList.toggle("active", i === state.step);
      }

      backBtn.disabled = (state.step === 1);
      nextBtn.disabled = !canAdvance(state.step);

      // Final step: Next becomes "Show results"
      nextBtn.textContent = (state.step === 4) ? "Show results" : "Next";
    }

    function goTo(step){
      state.step = step;
      resultEl.style.display = "none";
      copyBtn.disabled = true;
      updateProgress();
      saveState();
    }

    // ------------------------------------------------------------
    // Result building
    // ------------------------------------------------------------
    function buildResult(){
      if (!state.drone || !state.mode || !state.lighting || !state.mission) return;

      const d = DRONES[state.drone];
      const profile = pickProfile(state.drone);

      chipsEl.innerHTML = "";
      chipsEl.appendChild(chip(d.name, "ok"));
      chipsEl.appendChild(chip(state.pal ? "PAL 25/50" : "NTSC 30/60", "warn"));
      chipsEl.appendChild(chip(profile, supportsFlatProfile(state.drone) ? "ok" : "warn"));
      chipsEl.appendChild(chip(state.wb ? "WB locked" : "WB auto", state.wb ? "ok" : "warn"));

      kvEl.innerHTML = "";
      notesEl.innerHTML = "";
      specsEl.textContent = "";

      const noteLines = [];

      if (state.mode === "video" || state.mode === "both"){
        const fps = pickFps(state.mission);
        const sh = shutterForMission(fps, state.mission);
        const iso = isoSuggestion(state.lighting, state.drone);
        const nd = ndSuggestion(state.lighting, state.mission, state.drone);
        const wb = wbSuggestion(state.lighting);

        kvEl.appendChild(line("Video profile", profile));
        kvEl.appendChild(line("Frame rate", fps ? `${fps} fps` : "n/a"));
        kvEl.appendChild(line("Shutter speed", sh ? `${fmtShutter(sh.den)} (${sh.rule})` : "n/a"));
        kvEl.appendChild(line("ISO target", iso));
        kvEl.appendChild(line("ND filter", nd));
        kvEl.appendChild(line("White balance", wb));

        if (state.iso){
          noteLines.push("Low ISO priority: fix exposure with ND and shutter (within reason) before cranking ISO.");
        }
      }

      if (state.mode === "photo" || state.mode === "both"){
        const photo = photoPreset(state.lighting, state.drone);
        for (const [k,v] of photo){
          kvEl.appendChild(line(`Photo: ${k}`, v));
        }
      }

      const exp = exposureNotes(state.lighting, state.mission);
      exp.forEach(x => noteLines.push(x));
      if (d.notes) noteLines.push(d.notes);

      noteLines.push("If you’re grading later, protect highlights, you can lift shadows more safely than clipped sky.");
      noteLines.push("Do a 3-second test clip, check it, then commit.");

      notesEl.innerHTML = "<ul style='margin:8px 0 0; padding-left: 18px;'>" +
        noteLines.map(x => `<li>${x}</li>`).join("") +
        "</ul>";

      specsEl.textContent =
        `Camera notes: ${d.sensor} • ${d.aperture} • Max video: ${d.maxVideo} • Flat profile: ${d.log} • ND: ${d.nd}`;

      resultEl.style.display = "block";
      copyBtn.disabled = false;

      // Scroll to result on mobile
      resultEl.scrollIntoView({ behaviour: "smooth", block: "start" });
    }

    // ------------------------------------------------------------
    // Persistence
    // ------------------------------------------------------------
    function saveState(){
      const s = {
        step: state.step,
        drone: state.drone,
        mode: state.mode,
        lighting: state.lighting,
        mission: state.mission,
        pal: state.pal,
        wb: state.wb,
        flat: state.flat,
        iso: state.iso
      };
      try{ localStorage.setItem("fieldToolWizardState", JSON.stringify(s)); }catch(e){}
    }

    function loadState(){
      try{
        const raw = localStorage.getItem("fieldToolWizardState");
        if (!raw) return;
        const s = JSON.parse(raw);
        if (s && typeof s === "object"){
          state.step = s.step || 1;
          state.drone = s.drone || "";
          state.mode = s.mode || "";
          state.lighting = s.lighting || "";
          state.mission = s.mission || "";
          state.pal = (typeof s.pal === "boolean") ? s.pal : true;
          state.wb = (typeof s.wb === "boolean") ? s.wb : true;
          state.flat = (typeof s.flat === "boolean") ? s.flat : true;
          state.iso = (typeof s.iso === "boolean") ? s.iso : true;
        }
      }catch(e){}
    }

    function resetAll(){
      state.step = 1;
      state.drone = "";
      state.mode = "";
      state.lighting = "";
      state.mission = "";
      state.pal = true;
      state.wb = true;
      state.flat = true;
      state.iso = true;

      try{ localStorage.removeItem("fieldToolWizardState"); }catch(e){}

      // Re-render selections
      renderAll();
      goTo(1);
    }

    // ------------------------------------------------------------
    // Copy
    // ------------------------------------------------------------
    function copyResult(){
      const d = DRONES[state.drone];
      const profile = pickProfile(state.drone);

      const parts = [];
      parts.push(`Drone: ${d.name}`);
      parts.push(`Output: ${state.mode}`);
      parts.push(`Lighting: ${OPTIONS.lighting.find(x => x.value === state.lighting)?.title || state.lighting}`);
      parts.push(`Mission: ${OPTIONS.mission.find(x => x.value === state.mission)?.title || state.mission}`);
      parts.push(`System: ${state.pal ? "PAL (25/50)" : "NTSC (30/60)"}`);
      parts.push(`Profile: ${profile}`);
      parts.push(`WB: ${wbSuggestion(state.lighting)}`);

      if (state.mode === "video" || state.mode === "both"){
        const fps = pickFps(state.mission);
        const sh = shutterForMission(fps, state.mission);
        parts.push(`FPS: ${fps} fps`);
        parts.push(`Shutter: ${fmtShutter(sh.den)} (${sh.rule})`);
        parts.push(`ISO: ${isoSuggestion(state.lighting, state.drone)}`);
        parts.push(`ND: ${ndSuggestion(state.lighting, state.mission, state.drone)}`);
      }
      if (state.mode === "photo" || state.mode === "both"){
        parts.push(`Photo: ISO 100, RAW if available, AEB for HDR scenes`);
      }

      const text = parts.join("\n");
      navigator.clipboard.writeText(text).then(() => {
        copyBtn.textContent = "Copied";
        setTimeout(() => copyBtn.textContent = "Copy result", 900);
      }).catch(() => {
        alert("Couldn’t copy (browser blocked). You can select and copy from the results instead.");
      });
    }

    // ------------------------------------------------------------
    // Render all option steps
    // ------------------------------------------------------------
    function renderAll(){
      // Step 1
      renderOptions(droneOptions, OPTIONS.drone, state.drone, (val) => {
        state.drone = val;
        markSelected(droneOptions, val);

        const d = DRONES[val];
        droneHint.textContent = `Selected: ${d.name}. Camera: ${d.sensor}, ${d.aperture}.`;

        // Clear downstream if changing upstream choice
        state.mode = "";
        state.lighting = "";
        state.mission = "";
        renderAll();

        nextBtn.disabled = false;
        saveState();
      });

      // Step 2
      renderOptions(modeOptions, OPTIONS.mode, state.mode, (val) => {
        state.mode = val;
        markSelected(modeOptions, val);

        // If they pick photo only, mission "landscapePhoto" makes more sense, but we will not force it.
        state.lighting = "";
        state.mission = "";
        renderAll();

        nextBtn.disabled = false;
        saveState();
      });

      // Step 3
      renderOptions(lightingOptions, OPTIONS.lighting, state.lighting, (val) => {
        state.lighting = val;
        markSelected(lightingOptions, val);

        state.mission = "";
        renderAll();

        nextBtn.disabled = false;
        saveState();
      });

      // Step 4
      renderOptions(missionOptions, OPTIONS.mission, state.mission, (val) => {
        state.mission = val;
        markSelected(missionOptions, val);

        nextBtn.disabled = false;
        saveState();
      });

      // Toggles
      palToggle.checked = state.pal;
      wbToggle.checked = state.wb;
      flatToggle.checked = state.flat;
      isoToggle.checked = state.iso;
    }

    // ------------------------------------------------------------
    // Events
    // ------------------------------------------------------------
    backBtn.addEventListener("click", () => {
      if (state.step > 1) goTo(state.step - 1);
    });

    nextBtn.addEventListener("click", () => {
      if (!canAdvance(state.step)) return;

      if (state.step < 4){
        goTo(state.step + 1);
        return;
      }

      // Final step: show results
      buildResult();
      saveState();
    });

    resetBtn.addEventListener("click", resetAll);
    copyBtn.addEventListener("click", copyResult);

    palToggle.addEventListener("change", () => { state.pal = palToggle.checked; saveState(); if (resultEl.style.display === "block") buildResult(); });
    wbToggle.addEventListener("change", () => { state.wb = wbToggle.checked; saveState(); if (resultEl.style.display === "block") buildResult(); });
    flatToggle.addEventListener("change", () => { state.flat = flatToggle.checked; saveState(); if (resultEl.style.display === "block") buildResult(); });
    isoToggle.addEventListener("change", () => { state.iso = isoToggle.checked; saveState(); if (resultEl.style.display === "block") buildResult(); });

    // ------------------------------------------------------------
    // Init
    // ------------------------------------------------------------
    loadState();
    renderAll();

    // If we loaded with partial state, land them on the earliest incomplete step
    function firstIncompleteStep(){
      if (!state.drone) return 1;
      if (!state.mode) return 2;
      if (!state.lighting) return 3;
      if (!state.mission) return 4;
      return 4;
    }

    const targetStep = firstIncompleteStep();
    goTo(targetStep);

    // If everything is already filled, show results immediately
    if (state.drone && state.mode && state.lighting && state.mission){
      buildResult();
    }

    // Update button enabled state based on current step
    updateProgress();
  </script>
</body>
</html>
